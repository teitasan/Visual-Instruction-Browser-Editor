# Visual Instruction Browser Editor（Immersive Edition）設計仕様書（MVP最新版）

## 1. 概要

本システムは、HTMLソースコードを解析し、全画面プレビュー上で「視覚的な選択」と「自然言語による指示」を行うことで、コードを自動改変するブラウザベースのエディタである。専門的なIDEのUIを排除し、エンドユーザーが直感的に操作できる「没入型（Immersive）」のインターフェースを提供する。

* **正式名称**：Visual Instruction Browser Editor
* **略称**：VIBE

> **MVP方針**：要件を最小化し、選択（単一/複数） + LLM全体生成（HTML全文置換） + Undo に集中する。変更範囲の厳密保証や高度な特定ロジックは行わない。

---

## 2. ユーザー体験 (UX) フロー

### 2.1 ソースコードインポート

* **初期状態**: アプリ起動時、モーダルでHTMLソースコード入力を受け付ける。
* **バリデーション**: 入力が最低限のHTML構造（`<html>`等）を持つかチェックする（過剰なバリデーションは不要）。
* **サンプル読み込み**: デモ用テンプレートHTMLを展開する機能を持つ。

### 2.2 没入型プレビュー (Immersive Preview)

* **全画面表示**: 管理UIを排除し対象ページのみをビューポート全体に表示。
* **アイソレーション**: プレビュー対象HTMLは独立した `iframe`（`srcdoc`）内に描画する。

### 2.3 要素選択インタラクション（MVP）

* **クリック／タップ選択**: DOM要素をクリック（PC）またはタップ（スマートフォン）して選択・解除する（トグル）。
* **ホバー効果（必須）**:

  * PCではマウスオーバー時に即座にハイライト表示する。
  * スマートフォンではホバー相当の挙動は行わず、タップ時にハイライト兼選択とする。
* **複数選択（MVP）**: クリック／タップのトグル操作により複数要素を選択できる。
* **選択順序**: 追加された順（クリック順）を保持し、LLMへ渡す配列順序にも反映する。
* **UI連動**: 1つ以上の要素が選択されている場合のみ、画面下部のコマンドバーを入力可能状態へ遷移。

> **MVPではドラッグ範囲選択（Range Select）は必須ではない。まず複数選択（タップ／クリックのトグル）を優先する。**

### 2.4 自然言語による編集指示

* **フローティング・コマンドバー**: 画面下部に常駐し、選択中要素の概要（例：`<div.card>`）と選択ラベル（A/B/C...）を表示する。
* **指示入力**: ユーザーはテキストエリアに自然言語で指示を入力する（例：「AとCの順番を逆にして」）。
* **実行トリガー**: Enterキーまたは実行ボタンで編集処理を開始する。

### 2.5 フィードバックと更新

* **ローディング表現**: LLM処理中、画面全体にオーバーレイ（スピナー等）を表示して操作をブロックする。
* **反映**: 処理完了後、`iframe` の `srcdoc` を差し替えて即座に表示を更新する。

---

## 3. 技術アーキテクチャ・要件

> **技術スタック方針（将来拡張を前提）**
>
> * 将来的に **npmパッケージとして配布**し、任意のWebアプリに組み込み可能な構成とする。
> * 将来的に **Chrome拡張機能（MV3想定）**として提供できることを前提にする。
> * コアロジックは **フレームワーク非依存（Vanilla）** とし、UIと分離する。
> * 実装言語は **TypeScript** を基本とする。
> * UIは埋め込み容易性・CSS衝突回避のため、**Web Components（Shadow DOM）** で提供可能な構造を目指す（MVPでは段階的導入でもよい）。
> * React/Vue等のフレームワーク採用は必須要件としない（コアへの依存を禁止）。

### 3.1 フロントエンド構造

* **Main Application（親ウィンドウ）**: 状態管理（`currentSource`、選択情報、履歴、処理中フラグ）。
* **Preview Frame（iframe）**: ユーザーHTMLを `srcdoc` として表示。
* **Interaction Script（iframe内）**: 選択/ハイライトと、親への通知を担当。

### 3.2 DOM操作と通信（MVP）

* Interaction Script は `click`（スマホはタップ相当）を捕捉し、選択要素の `outerHTML` を取得して親へ通知する。
* **要素の区別（MVP）**: 同一構造要素が複数存在するケースに対応するため、選択時に対象要素へ一時的な識別子属性 `data-vibeditor-id` を付与して区別する。

  * `data-vibeditor-id` はユーザーが指示しやすいよう **A, B, C...** の通しラベルを採用する（選択された順に付与）。
  * 選択中は、対象要素付近にラベル（A/B/C...）を表示してユーザーが参照できるようにする。
  * 表示はハイライト枠に付随する **付箋（sticky note）風のバッジ**として描画する（例：枠の左上に重ねる）。
  * **ラベル割り当てルール（MVP）**:

    * ラベルは選択された順に A, B, C... と付与する。
    * 選択解除で空いたラベルは再利用しない。
    * 選択が0件になった時点で、次回の選択は再び A から付与する。
* 編集モード中はリンク遷移やフォーム送信等の既定動作を抑止する（`preventDefault` / `stopPropagation`）。
* 親ウィンドウとiframe間の通信は `window.postMessage` を用いる。

#### 3.2.1 postMessage Payload（iframe → 親）

* クリック／タップ選択時、iframeは選択状態（単一/複数）を親へ通知する。
* `targets` には `label`（A/B/C...）を含める。

```json
{
  "type": "selected",
  "selectionType": "multi",
  "targets": [
    { "label": "A", "outerHTML": "<div class=\"card\" data-vibeditor-id=\"A\">...</div>", "tagName": "div" },
    { "label": "B", "outerHTML": "<li data-vibeditor-id=\"B\">...</li>", "tagName": "li" }
  ]
}
```

> **MVPでは CSS Selector / XPath の生成は行わない。** 複数選択は `outerHTML` の配列で表現する。

---

## 4. LLMインタラクション・ロジック（MVP：全体生成）

### 4.1 入力 / 出力

* **入力**: `currentSource`（HTML全文） + `target_outerHTMLs`（選択要素outerHTMLの配列） + `user_instruction`
* **出力**: 編集後のHTML全文を **JSONでラップして返す**

> 使用するLLMは特定ベンダー/特定モデルに固定せず、コスト・性能に応じて差し替え可能とする。

### 4.2 LLM Request Payload

```json
{
  "source_full": "<!doctype html><html>...</html>",
  "target_outerHTMLs": [
    "<div class='card' data-vibeditor-id='A'>...</div>",
    "<li data-vibeditor-id='B'>...</li>"
  ],
  "user_instruction": "AとBの順番を逆にして",
  "model": "<llm-model-id>"
}
```

### 4.3 LLM Response（JSONラップ）

```json
{
  "full_html": "<!doctype html><html>...</html>"
}
```

### 4.4 System Prompt（要点）

* 入力HTMLドキュメント全体を、ユーザー指示に従って編集し、**編集後のHTML全文のみ**を返す。
* 編集対象は `target_outerHTMLs` に対応する要素（複数可）とし、その他の変更は最小限に留める。
* ユーザーはラベル（A/B/C...）を用いた指示を行えることを想定し、プロンプトには `data-vibeditor-id`（ラベル）を含む `target_outerHTMLs` を渡す。
* 解説や前置きは返さない（JSONの `full_html` のみ）。

### 4.5 出力処理（Sanitization & Replace）

* AIレスポンスから `full_html` を取得。
* `full_html` に対してサニタイズ処理を行う。

  * `<script>` タグ除去
  * 危険な属性（`on*`）無害化
  * 危険URLスキーム排除（例：`javascript:`）
* **一時属性の除去（MVP）**: 選択識別のために付与した `data-vibeditor-id` は、AIの返却HTML受領後に全体から除去する（サニタイズ工程内または直後）。

  * ラベル表示用の付随要素（バッジ等）をDOMへ挿入した場合も同様に除去する。
* サニタイズ後のHTMLを `currentSource` として **全体置換**。
* 反映は `iframe.srcdoc = currentSource` の差し替えで行う。

> **変更範囲の厳密な保証（差分検証・自動修復等）は行わない。** 想定外の変更が起きた場合はUndoで復旧可能とする。

---

## 5. エラーハンドリング（MVP）

### 5.1 パースエラー

* ユーザー入力HTMLが壊れている場合は警告表示し、可能なら最低限の補完またはサンプル読み込みを促す。

### 5.2 LLM生成失敗

**失敗条件（MVP）**

* LLMレスポンスが空
* `full_html` が空
* HTMLとしてパース不能
* サニタイズ後に致命的に壊れる（例：空になる、`<html>` が消える）

**失敗時の挙動**

* 変更は適用しない（`currentSource` を更新しない）
* トースト等で再試行を促す
* 指示入力欄は保持する

---

## 6. Undo（履歴）仕様（MVP）

### 6.1 粒度

* **LLMの1回の生成（＝1回の適用）につき1履歴**を積む。
* 適用直前の `currentSource` を履歴スタックに保存する。
* LLM失敗で適用しない場合は履歴を積まない。

### 6.2 Undo操作

* Undo実行で履歴から1つ取り出し、`currentSource` をその値に戻す。
* 戻した後は `iframe.srcdoc` を差し替えてプレビュー更新。
* 履歴が空ならUndoは無効（ボタンdisabled）。

### 6.3 履歴上限（任意）

* 実装都合で上限を付ける場合は 20〜50件程度。

---

## 7. データモデル定義（MVP）

### 7.1 Application State

```ts
interface AppState {
  currentSource: string;
  isProcessing: boolean;
  history: string[];
  selectionMode: 'click';
  selection: SelectionInfo | null; // 選択0件ならnull
  lastInstruction?: string;
}

interface SelectionInfo {
  type: 'single' | 'multi';
  targets: Array<{
    label: string; // A/B/C...
    tagName?: string;
    outerHTML: string;
  }>;
}
```

---

## 8. UIコンポーネント仕様（MVP）

> **UIデザイン方針（共通）**
>
> * 全体的に **グラスモーフィズム**（半透明、背景ブラー、柔らかい境界、控えめな影）を意識したモダンな見た目とする。
> * ハイライト枠、付箋バッジ、コマンドバー、モーダルは同一トーンで統一する。

### 8.1 Command Bar (Floating)

* 配置: 画面下部中央、z-index高め。
* 構成:

  * ステータス/ターゲット表示（選択要素概要 + 選択ラベル一覧）
  * 指示入力エリア
  * 実行ボタン
  * Undoボタン

状態:

* **Idle**: 入力不可「要素を選択してください」
* **Active**: 入力可
* **Processing**: ローディング表示、操作ブロック

### 8.2 Source Modal

* `currentSource` 文字列を表示
* コピー機能

---

## 9. セキュリティと制約（MVP）

* LLM出力はサニタイズを通す（script除去、on*無害化、危険URL排除）。
* 外部リソース読み込みはブラウザのセキュリティポリシーに依存する。
* 編集モード中の既定動作は抑止する（リンク遷移・フォーム送信など）。

---

## 10. 画面仕様（MVP）

本章では、LLMに実装イメージを正しく伝えるため、VIBEの画面構成とUI要素を具体的に定義する。MVPにおける主要画面は以下の2つのみとする。

### 10.1 ソースファイル入力モーダル

#### 目的

* 編集対象となるHTMLソースをユーザーに入力させるための初期画面。
* アプリ起動直後に必ず表示される。

#### 表示仕様

* 画面中央に表示されるモーダルダイアログ。
* 背景は半透明のオーバーレイで覆い、背後操作は不可。
* モーダルは角丸・グラスモーフィズム調のデザインとする。

#### 構成要素

* **HTML入力フォーム**

  * `<textarea>` 形式でHTMLソースを直接貼り付け可能。
  * ファイル選択（`<input type="file">`）によるHTMLファイル読み込みにも対応してよい。
* **デフォルトHTML**

  * 入力が空の状態でモーダルを開いた場合、サンプル用のHTMLテンプレートを自動で挿入する。
  * サンプルHTMLは、ヘッダー・本文・ボタン等を含む簡易な構造とする。
* **開始ボタン**

  * 入力されたHTMLを確定し、メイン画面へ遷移する。

#### 挙動

* ユーザーがHTMLを編集・確定するとモーダルを閉じ、iframeプレビューを生成する。
* 無効なHTMLの場合は軽微な警告を表示する（致命的でなければブロックしない）。

---

### 10.2 メイン画面

#### 全体構成

* ブラウザ内の表示領域を**全面的に使用**する。
* 管理用のヘッダー、サイドバー、フッターは持たない。

#### プレビュー領域

* 画面全体に `iframe` を配置し、ユーザーのHTMLを `srcdoc` として描画する。
* iframeはVIBE本体のCSSやJSの影響を受けない。

#### コマンド入力ウインドウ（常駐）

* 画面下部中央に固定表示される。
* 横長の角丸長方形。
* グラスモーフィズムデザイン（半透明背景＋ブラー＋薄い枠線）。

##### 構成要素

* **テキスト入力フォーム**

  * 自然言語指示を入力するための単一行または複数行入力欄。
  * プレースホルダ例：「背景を青にして」「AとCの順番を逆にして」
* **送信ボタン**

  * 入力内容をLLMへ送信し、編集を実行する。
* **戻るボタン（Undo）**

  * 直前の編集状態に戻す。
* **進むボタン（Redo）**

  * 将来拡張用。MVPでは無効または非表示でもよい。

#### 状態

* **非アクティブ状態**

  * 要素が選択されていない場合、入力フォームは非活性。
  * ガイド文「要素を選択してください」を表示。
* **アクティブ状態**

  * 1つ以上の要素が選択されている場合、入力可能。
* **処理中状態**

  * LLM処理中は送信不可。
  * 画面全体に半透明オーバーレイとスピナーを表示する。

#### 補足

* 選択中要素はハイライト枠と付箋風ラベル（A/B/C...）で常に可視化される。
* コマンド入力ウインドウはiframeの上に重ねて表示され、スクロールに影響されない。
